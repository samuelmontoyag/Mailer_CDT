{% extends "base.html" %}
{% import 'form_helper.html' as lib with context %}


{%block content_wrapper%}
<section class="content-header">
  <h1>
    Campañas de mailing
  </h1>
</section>
<section class="content">
  <div class="row">
    <div class="col-md-3">
      <a href="/campagnas/create" class="btn btn-lg btn-primary btn-block margin-bottom">Crear mailing</a>

      {%call lib.create_box("Áreas", "box-solid") %}
        <div>
          <ul class="sidebar-nav" id=folder_list>
            <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
          </ul>
        </div>
        <div style="text-align: center;">
          
        <a href="#" class='btn btn-primary add_campaign' >Agregar Área</a>
      {%endcall%}
        </div>
    </div>
    
    <div class="col-md-9">
      {%call lib.create_box("Mailings", "box-primary")%}
        {% if current_folder != None and  current_folder|string != '0' %}
          <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">Opciones <span class="caret"></span></button>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="#" data-toggle="modal" data-target="#deleteAreaModal" class="deleteAreaModal">Eliminar Área</a>
              </li>
            </ul>
          </div>
        {% endif %}
        
        <table class="table table-hover table-striped able table-bordered">
          <tr>
            <th align="center">Nombre</th>
            <th style="display:None">fecha creacion</th>
            <th>Email salida</th>
            <th style="display:None">Asunto salida</th>
            <th>Ultimo envio</th>
            <th>Emails enviados</th>
            <th>Área</th>
            <th></th>
          </tr>
          <tbody id="mailing_list">
            <tr>
              <td colspan="6">
                <div class="jumbotron text-center">
                  <h2 class="text-aqua"><i class="fa fa-cog fa-spin fa-2x fa-fw" aria-hidden="true"></i> Cargando ...</h2>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      {% endcall %}
    </div>
  </div>
</section>
<!--  
********************
Modals 
********************-->
<div class="modal fade" id="deleteAreaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/campagnas/folder/remove/">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Eliminar Área</h4>
        </div>
        <div class="modal-body">
          ¿Seguro que desea eliminar esta Área?
          <input type="hidden" name="id_folder" value="{{current_folder}}">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-default" >Seguro</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Eliminar Mailing</h4>
      </div>
      <div class="modal-body">
        <table class="table table-hover table-striped able table-bordered">
      <tr>
        <th>Nombre</th>
        <th>fecha creacion</th>
        <th>Ultimo envio</th>
        <th>Emails enviados</th>
      </tr>
      <tr>
        <td id="nameAlert"></td>
        <td id="createAlert"></td>
        <td id="lastSendAlert"></td>
        <td id="emailsAlert"></td>
      </tr>
    </table>
        <div class="alert alert-danger">
          ¿Estas Seguro?<br />
          Una vez borrada, no podras recuperar este mailing.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <form method="POST" id="confirmDeleteForm" action="/campagnas/delete">
          <input type="hidden" name="id" value="0" id="deleteID">
          <button type="submit" id="confirmDelete" class="btn btn-primary">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="cambiarAreaModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
        <form method="POST" action="/campagnas/folder/setArea">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">cambiar Área</h4>
          </div>
          <div class="modal-body">
            <table class="table table-hover table-striped able table-bordered">
                <tr><th>Nombre</th></tr>
                <tr><td id="nameAlert"></td></tr>
                <tr><td id="areaAlert"></td></tr>
            </table>
            <label for="name">Selecione la nueva Área</label>
            <select name="area"  class="form-control">
              {% for folder in folders %}
                <option value="{{folder.folder_id}}">{{folder.name}}</option>l
              {% endfor %}
            </select>
            <input type="hidden" name="id" value="0" id="campainID">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-default" >Cambiar</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
  </div>
</div>
{% endblock %}
       



{% block extra_js %}

<script src="/static/js/handlebars.js"></script>
{% raw %}

<script type="text/javascript">  
  Handlebars.registerHelper('if_eq', function(a, b, opts) {
    if (a == b) {
        return opts.fn(this);
    } else {
        return opts.inverse(this);
    }
  });
</script>

<script id="mailing-template" type="text/x-handlebars-template">
  {{#each data}}
  <tr id="c{{campaign.id}}">
    <td id="name"><a href="/campagnas/detalles/{{id}}">{{title}}</a></td>

    <td id="create" style="display:None">{{create_time}}</td>
    <td>{{from_name}} &lt;{{from_email}}&gt;</td>
    <td style="display:None">{{subject}}</td>
    <td id="lastSend">{{send_time}}</td>
    <td id="emails">{{emails_sent}}</td>


    <td id="area" class="area_td" data_folder_id="{{folder}}">
      {{folder_id}}
    </td>

    <td>
      <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
          Opciones <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          <li><a href="/campagnas/detalles/{{id}}">Detalles</a></li>
          {{#if_eq send_time None}}
          <li><a href="/campagnas/edit/{{id}}">Editar</a></li>
          
          {{else}}
          <li><a href="/campagnas/clone/{{id}}">Clonar</a></li>
          {{/if_eq}}

          
          {{#if_eq send_time None}}
          <li><a href="#" data-toggle="modal" data-id="{{id}}" data-target="#cambiarAreaModal" class="cambiarAreaModal">Mover a otra Área</a></li>
          {{/if_eq}}
          <li><a href="#" data-toggle="modal" data-id="{{id}}" data-target="#deleteModal" class="deleteModal">Eliminar</a></li>
        </ul>
      </div>      
    </td>
  </tr>
  {{else}}
  <tr>
    <td colspan="10"><div><h3>No hay campañas creadas</h3></div></td>
  </tr>
  {{/each}}
</script>
<script id="areas-template" type="text/x-handlebars-template">
  <li>
    <a href="/campagnas">Todos</a>
  </li>
  {{#each this}}
    <li>
      <a href="/campagnas/folder/{{folder_id}}">{{name}}</a> <span>({{cnt}})</span>
    </li>
  {{/each}}
</script>
{% endraw %}


<script type="text/javascript">
  $(function(){
    var mailing_template =  Handlebars.compile($("#mailing-template").html());
    var areas_template =  Handlebars.compile($("#areas-template").html());
    
    $.ajax({
      url: "{{url_for('.ajax_folder_list')}}",
      dataType: 'json',
      success: function(data) {
        // console.log(data)
        var htmlData = areas_template(data)
        $("#folder_list").html(htmlData);
      }
    });
    $.ajax({
      url: "{{url_for('.ajax_listar_campagnas')}}",
      dataType: 'json',
      success: function(data) {
        // console.log(data)
        var htmlData = mailing_template(data);
        $("#mailing_list").html(htmlData);
      }
    });

    $(".deleteModal").on("click", function () {
      var campaign_id = $(this).data('id');
      $("#deleteID").val(campaign_id);
      tr = $("#c"+campaign_id)
      $("td#nameAlert").text($(tr).children('td#name').text())
      $("td#createAlert").text($(tr).children('td#create').text())
      $("td#lastSendAlert").text($(tr).children('td#lastSend').text())
      $("td#emailsAlert").text($(tr).children('td#emails').text())
    })
    $(".cambiarAreaModal").on("click", function () {
        var campaign_id = $(this).data('id');
        $("#campainID").val(campaign_id);
        tr = $("#c"+campaign_id)
        $("td#nameAlert").text($(tr).children('td#name').text())
        $("td#areaAlert").text("Área actual: "+$(tr).children('td#area').text())
    })
    $("#confirmDelete").on("click", function () {
      $("#confirmDelete").text("Eliminando ...");
      $("#confirmDelete").attr("disabled", "disabled");
      $("#confirmDeleteForm").submit()
    });
  })
</script>
<script type="text/javascript">
   $(".add_campaign").on('click', function(event){
      event.preventDefault();
      swal({
        title: 'Indique el nombre del área',
        input: 'text',
        showCancelButton: true,
        cancelButtonText: 'Atrás',
        confirmButtonText: 'Crear',
        allowOutsideClick: false,
        reverseButtons: true,
        inputValidator: function (value) {
          return new Promise(function (resolve, reject) {
            if (value) {
              resolve()
            } else {
              reject('Debes indicar un nombre de área!')
            }
          })
        }
      }).then(function (result) {
        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", '/campagnas/folder/add/');
        var nombre_campagna = document.createElement("input");
        nombre_campagna.setAttribute("type", "hidden");
        nombre_campagna.setAttribute("name", 'name');
        nombre_campagna.setAttribute("value", result);
        form.appendChild(nombre_campagna);
        document.body.appendChild(form);
        form.submit();
        swal({
          type: 'success',
          html: 'Lista Creada: ' + result
        })
      }).catch(swal.noop);
    });


</script>
{% endblock %}
